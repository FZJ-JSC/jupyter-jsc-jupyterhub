{%- macro table_actions(name, active, service, option1, system, account, project, partition, reservation, runtime, nodes, gpus) -%}
{# Set config related variables #}
{%- set vo_allowed_list = vo_services.get(service, {}).get(option1, {}).get("replace_allowed_lists", {}) -%}
{%- set vo_resources = vo_services.get(service, {}).get(option1, {}).get("replace_resources", {}) -%}
{%- set service_allowed_list = custom_config.get("services").get(service, {}).get("options", {}).get(option1, {}).get("allowed_lists", {}) -%}

{# Logic to determine if a lab can be opened/started #}
{# If not a Lab from the current VO -- Not sure about this #}
{# {%- if auth_state.get("vo_active", "") != user_options.get("vo_active_input") -%} {%- set na = 1 -%} #}
{# System is in maintenance #}
{%- if system in maintenance_list -%} {%- set na = 1 -%}
{# System is not in replace_allowed_lists of the VO config #}
{%- elif "systems" in vo_allowed_list.keys()
   and system not in vo_allowed_list.get("systems", []) -%} {%- set na = 1 -%}
{# System not in allowed list of the services config and not overwritten in the VO config #}
{%- elif system not in service_allowed_list.get("systems", []) 
   and system not in vo_allowed_list.get("systems", []) -%} {%- set na = 1 -%}
{# Service or service option not allowed for active VO #}
{%- elif service not in vo_services.keys() or option1 not in vo_services.get(service, {}).keys() -%} {%- set na = 1 -%}
{# Account is not in replace_allowed_lists of the VO config #}
{%- elif "accounts" in vo_allowed_list.keys()
   and account not in vo_allowed_list.get("accounts", []) -%} {%- set na = 1 -%}
{# Project is not in replace_allowed_lists of the VO config #}
{%- elif "projects" in vo_allowed_list.keys()
   and project not in vo_allowed_list.get("projects", []) -%} {%- set na = 1 -%}
{# Project does not exists anymore for the system #}
{# {%- elif project != None 
   and project not in dropdown_lists.get("options", {}).get(option1, {}).get(system, {}).get(account, {}).keys() -%} {%- set na = 1 -%} #}
{# Partition is not in replace_allowed_lists of the VO config #}
{%- elif "partitions" in vo_allowed_list.keys()
   and partition not in vo_allowed_list.get("partitions", []) -%} {%- set na = 1 -%}
{# Reservation is not in replace_allowed_lists of the VO config #}
{%- elif "reservations" in vo_allowed_list.keys()
   and reservation not in vo_allowed_list.get("reservations", []) -%} {%- set na = 1 -%}
{# Runtime is smaller than min allowed runtime or greater than max allowed runtime as per the VO config #}
{%- elif "Runtime" in vo_resources.get(system, {}).get(partition, {}).keys() 
   and (
     (runtime|int / 60) < vo_resources.get(system, {}).get(partition, {}).get("Runtime", [[0,1], 0])[0][0] 
     or (runtime|int / 60) > vo_resources.get(system, {}).get(partition, {}).get("Runtime", [[0,1], 0])[0][1] 
   ) -%} {%- set na = 1 -%}
{# Number of nodes is smaller than min allowed number or greater than max allowed number as per the VO config #}
{%- elif "Nodes" in vo_resources.get(system, {}).get(partition, {}).keys() 
   and ( 
     (nodes|int) < vo_resources.get(system, {}).get(partition, {}).get("Nodes", [[0,1], 0])[0][0]
     or (nodes|int) > vo_resources.get(system, {}).get(partition, {}).get("Nodes", [[0,1], 0])[0][1] 
   ) -%} {%- set na = 1 -%}
{# Number of GPUS is smaller than min allowed number or greater than max allowed number as per the VO config #}
{%- elif "GPUS" in vo_resources.get(system, {}).get(partition, {}).keys() 
   and (
     (gpus|int) < vo_resources.get(system, {}).get(partition, {}).get("GPUS", [[0,1], 0])[0][0]
     or (gpus|int) > vo_resources.get(system, {}).get(partition, {}).get("GPUS", [[0,1], 0])[0][1] 
   ) -%} {%- set na = 1 -%}

{%- else -%} {%- set na = 0 -%}
{%- endif -%}

<div class="d-inline-flex justify-content-center">
  {%- set margin = "me-3"%}
  {# Save N/A status to page #}
  <span class="na-status d-none">{{na}}</span>
  {# N/A #}
  <button type="button" class="btn btn-secondary disabled {%- if na == 0 %} d-none {%- endif %} na {{margin}}">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dash-circle-dotted" viewBox="0 0 16 16">
      <path d="M8 0c-.176 0-.35.006-.523.017l.064.998a7.117 7.117 0 0 1 .918 0l.064-.998A8.113 8.113 0 0 0 8 0zM6.44.152c-.346.069-.684.16-1.012.27l.321.948c.287-.098.582-.177.884-.237L6.44.153zm4.132.271a7.946 7.946 0 0 0-1.011-.27l-.194.98c.302.06.597.14.884.237l.321-.947zm1.873.925a8 8 0 0 0-.906-.524l-.443.896c.275.136.54.29.793.459l.556-.831zM4.46.824c-.314.155-.616.33-.905.524l.556.83a7.07 7.07 0 0 1 .793-.458L4.46.824zM2.725 1.985c-.262.23-.51.478-.74.74l.752.66c.202-.23.418-.446.648-.648l-.66-.752zm11.29.74a8.058 8.058 0 0 0-.74-.74l-.66.752c.23.202.447.418.648.648l.752-.66zm1.161 1.735a7.98 7.98 0 0 0-.524-.905l-.83.556c.169.253.322.518.458.793l.896-.443zM1.348 3.555c-.194.289-.37.591-.524.906l.896.443c.136-.275.29-.54.459-.793l-.831-.556zM.423 5.428a7.945 7.945 0 0 0-.27 1.011l.98.194c.06-.302.14-.597.237-.884l-.947-.321zM15.848 6.44a7.943 7.943 0 0 0-.27-1.012l-.948.321c.098.287.177.582.237.884l.98-.194zM.017 7.477a8.113 8.113 0 0 0 0 1.046l.998-.064a7.117 7.117 0 0 1 0-.918l-.998-.064zM16 8a8.1 8.1 0 0 0-.017-.523l-.998.064a7.11 7.11 0 0 1 0 .918l.998.064A8.1 8.1 0 0 0 16 8zM.152 9.56c.069.346.16.684.27 1.012l.948-.321a6.944 6.944 0 0 1-.237-.884l-.98.194zm15.425 1.012c.112-.328.202-.666.27-1.011l-.98-.194c-.06.302-.14.597-.237.884l.947.321zM.824 11.54a8 8 0 0 0 .524.905l.83-.556a6.999 6.999 0 0 1-.458-.793l-.896.443zm13.828.905c.194-.289.37-.591.524-.906l-.896-.443c-.136.275-.29.54-.459.793l.831.556zm-12.667.83c.23.262.478.51.74.74l.66-.752a7.047 7.047 0 0 1-.648-.648l-.752.66zm11.29.74c.262-.23.51-.478.74-.74l-.752-.66c-.201.23-.418.447-.648.648l.66.752zm-1.735 1.161c.314-.155.616-.33.905-.524l-.556-.83a7.07 7.07 0 0 1-.793.458l.443.896zm-7.985-.524c.289.194.591.37.906.524l.443-.896a6.998 6.998 0 0 1-.793-.459l-.556.831zm1.873.925c.328.112.666.202 1.011.27l.194-.98a6.953 6.953 0 0 1-.884-.237l-.321.947zm4.132.271a7.944 7.944 0 0 0 1.012-.27l-.321-.948a6.954 6.954 0 0 1-.884.237l.194.98zm-2.083.135a8.1 8.1 0 0 0 1.046 0l-.064-.998a7.11 7.11 0 0 1-.918 0l-.064.998zM4.5 7.5a.5.5 0 0 0 0 1h7a.5.5 0 0 0 0-1h-7z"/>
    </svg>
    N/A
  </button>
  {# Open #}
  {%- if na != 1 -%}
  <button type="button" class="btn btn-success open {%- if not active %} d-none {%- endif %} {{margin}}" data-server-url='/user/{{user.name}}/{{name}}'>
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
      <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
    </svg>
    Open
  </button>
  {%- endif -%}
  {# Stop #}
  <button type="button" class="btn btn-danger stop {%- if not active %} d-none {%- endif -%}">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stop-circle" viewBox="0 0 16 16">
      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
      <path d="M5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5v-3z"/>
    </svg>
    Stop
  </button>
  {# Start #}
  {%- if na != 1 -%}
  <button type="button" id="{{name}}-start-btn" class="btn btn-primary start {%- if active %} d-none {%- endif %} {{margin}}"
    href="{{base_url}}spawn/{{user.name}}/{{name}}" target="_blank">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16">
      <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"></path>
    </svg>
    Start
  </button>
  {%- endif -%}
</div>
{%- endmacro -%}

{%- macro vertical_tab(title, key, active=false) -%}
<li class="nav-item" role="presentation">
  <a id="{{key}}-tab" class="nav-link {%- if active %} active{%- endif -%}" 
    data-bs-toggle="tab" data-bs-target="#{{key}}" role="tab" aria-controls="{{key}}" aria-selected="true">
    <span class="align-middle pb-1">{{ title }}</span>
    <span id="{{key}}-tab-warning" class="badge rounded-pill bg-warning p-1 align-middle" style="display: none">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation" viewBox="0 0 16 16">
        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0L7.1 4.995z"/>
      </svg>
      <span class="visually-hidden">settings changed</span>
    </span>
  </a>
</li>
{%- endmacro -%}

{%- macro tab_content(key, active=false, form=true) -%}
<div class="tab-pane fade {%- if active -%}show active{%- endif -%}" role="tabpanel"
  aria-labelledby="{{key}}-tab" id="{{key}}">
  {%- if form %}
  <form id="{{key}}-form">
    {{ caller() }}
  </form>
  {%- else -%}
  {{ caller() }}
  {%- endif %}
</div>
{%- endmacro -%}

{%- macro form_div(label, key, sm=2) -%}
{%- set key = key + "-" + label.lower() -%}
<div id="{{key}}-select-div" class="row mb-3">
  <label for="{{key}}-select" class="col-sm-{{sm}} col-form-label">
    <span class="align-middle">{{ label }}</span>
    <span id="{{key}}-warning" class="badge rounded-pill bg-warning p-1 align-middle" style="display: none">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation" viewBox="0 0 16 16">
        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0L7.1 4.995z"/>
      </svg>
      <span class="visually-hidden">settings changed</span>
    </span>
  </label>
  <div class="col-sm-{{12-sm}}">
    <select id="{{key}}-select" class="form-select" required></select>
    <div class="invalid-feedback">
      Please choose a {{ label.lower() }}.
    </div>
  </div>
</div>
{%- endmacro -%}

{%- macro form_number_div(label, key) -%}
{%- set key = key + "-" + label.lower() -%}
<div id="{{key}}-input-div" class="row mb-3">
  <label for="{{key}}-input" class="col-sm-5 col-form-label">    
    <span id="{{key}}-text" class="align-middle">{{ label }}</span>
    <span id="{{key}}-warning" class="badge rounded-pill bg-warning p-1 align-middle" style="display: none">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation" viewBox="0 0 16 16">
        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0L7.1 4.995z"/>
      </svg>
      <span class="visually-hidden">settings changed</span>
    </span>
  </label>
  <div class="col-sm-7">
    <input type="number" id="{{key}}-input" class="form-control" value="-1">
    <div class="invalid-feedback"></div>
  </div>
</div>
{%- endmacro -%}

{%- macro create_tr(name, active, service, option1, system, account, project, partition, reservation, runtime, nodes, gpus) -%}
<tr data-server-name="{{name}}">
  <td class="details" data-bs-target="#{{name}}-collapse">
    <div class="d-flex mx-auto accordion-icon collapsed"></div>
  </td>
  <th scope="row">{{ name }}</th>
  <td class="system-td">{{ system }}</td>
  <td class="partition-td">
    {%- if partition == None %}
    <span class="text-muted">N/A</span>
    {%- else -%}
    {{ partition }}
    {%- endif %}
  </td>
  <td class="project-td">
    {%- if project == None %}
    <span class="text-muted">N/A</span>
    {%- else %}
    {{ project }}
    {%- endif %}
  </td>
  <td class="status-td">
    <div class="d-inline-flex flex-wrap align-items-center g-0">
      <div class="col-auto my-2">
        <div class="progress flex-grow-1 me-3" style="height: 20px; min-width: 100px;">
          <div id="{{name}}-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
          aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
      <div class="col-auto">
        <a class="progress-log-btn" role="button">
	        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
  	        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
          </svg>
        </a>
      </div>
    </div>
  </td>
   <td class="actions-td">{{ table_actions(name, active, service, option1, system, account, project, partition, reservation, runtime, nodes, gpus) }}</td>
</tr>
{%- endmacro -%}

{%- macro create_tr_collapse(name) -%} {# Collapsed detailed information #}
<tr data-server-name="{{name}}" class="collapse-tr" style="--bs-table-accent-bg: transparent;">
  {# Remove padding from table data cell to hide the row when collapsed #}
  <td colspan=12 class="p-0">
    {# Do not add padding here as it messes up the transition #}
    <div class="collapse px-2" id="{{name}}-collapse">
      <div class="row collapse-row g-0 p-2">

        <div class="row g-0 mt-2">
          {# Vertical tabs #}
          <div class="col-md-3 col-xl-2">
            <ul class="nav nav-tabs left-tabs" role="tablist">
              {{ vertical_tab("Service", name + "-service", active=true) }}
              {{ vertical_tab("Options", name + "-options") }}
              {{ vertical_tab("Resources", name + "-resources") }}
              {{ vertical_tab("Reservation", name + "-reservation") }}
              {# {{ vertical_tab("Modules", name + "-modules") }} #}
              {# {{ vertical_tab("Kernel", name + "-kernel") }} #}
              {{ vertical_tab("Logs", name + "-logs") }}
              </li>
            </ul>
          </div>

          {# Vertical tab content #}
          <div class="col-md-9 col-xl-10">
            <div id="{{name}}-configuration" class="tab-content">
              {%- call tab_content(name + "-service", active=true) -%}
              <div class="row mb-3">
                <label for="{{name}}-name-input" class="col-sm-2 col-form-label">Name</label>
                <div class="col-sm-10">
                  <input type="name" class="form-control" id="{{name}}-name-input" value="{{name}}" disabled>
                </div>
              </div>
              {{ form_div("Type", name) }}
              {%- endcall -%}
              {%- call tab_content(name + "-options") -%}
              {{ form_div("System", name) }}
              {{ form_div("Account", name) }}
              {{ form_div("Project", name) }}
              {{ form_div("Partition", name) }}
              {%- endcall -%}
              {%- call tab_content(name + "-resources") -%}
              <form id="{{name}}-resources-form">
                {{ form_number_div("Nodes", name) }}
                {{ form_number_div("GPUs", name) }}
                {{ form_number_div("Runtime", name) }}
              </form>
              {%- endcall -%}
              {%- call tab_content(name + "-reservation") -%}
              {{ form_div("Reservation", name) }}
              {%- endcall -%}
              {%- call tab_content(name + "-modules") -%}
              {%- endcall -%}
              {%- call tab_content(name + "-kernel") -%}
              {%- endcall -%}
              {%- call tab_content(name + "-logs", form=False) -%}
                <div id="{{name}}-progress-log" class="card card-body"></div>
              {%- endcall -%}
            </div>
          </div>
        </div>

        {# Vertical line #}
        <div class="col-md-3 col-xl-2" style="border-right: 1px solid #dee2e6"></div>

        {# Edit buttons #}
        <div class="col-md-9 col-xl-10 mb-3 px-3">
        <hr>
          <div class="d-flex align-items-center">
            <button  id="{{name}}-save-btn" class="btn btn-success save me-2" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
              </svg>
              <span class="align-middle">Save</span>
            </button>
            <button id="{{name}}-reset-btn" class="btn btn-danger reset me-2" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
                <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
              </svg>
              <span class="align-middle">Reset</span>
            </button>
            <div class="alert fade pe-none mb-0 p-2" role="alert">
              <span class="align-middle">An example message</span>
              <button type="button" class="btn-close align-middle" onClick="$(this).parent().removeClass('show'); $(this).parent().addClass('pe-none');"></button>
            </div>
            <button type="button" class="btn btn-danger delete ms-auto">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
              </svg>
              Delete Lab
            </button>
          </div>
        </div>

      </div> {# End of row div of collapse #}
    </div> {# End of collapse div #}
  </td>
</tr>
{%- endmacro -%}
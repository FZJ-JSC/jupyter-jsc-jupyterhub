{%- extends hostname + "/page.html" -%}

{%- block stylesheet -%}
{# <link rel="stylesheet" href='{{ static_url("css/admin.css", include_version=False) }}'
  type="text/css" /> #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
{%- endblock -%}

{%- macro th(label, key='', colspan="") -%}
<th data-sort="{{key}}" colspan="{{colspan}}">
  {{ label }}
  {%- if key %}
  <a href="#users">
    <i class="fa {%- if sort.get(key) == 'asc' -%} fa-sort-asc
    {%- elif sort.get(key) == 'desc' -%} fa-sort-desc
    {%- else -%} fa-sort
    {%- endif %} sort-icon">
    </i>
  </a>
  {%- endif %}
</th>
{%- endmacro -%}


{%- block main -%}
<div class="mt-4 mx-4">

  <!-- Nav tabs -->
  <ul class="nav nav-pills" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link text-white active" id="logging-tab" data-bs-toggle="tab" href="#logging" role="tab" 
        aria-controls="logging" aria-selected="true">Logging</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link text-white" id="users-tab" data-bs-toggle="tab" href="#users" role="tab" 
        aria-controls="users" aria-selected="false">User Labs</a>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content" id="tab-content">
    <div class="tab-pane fade show active" id="logging" role="tabpanel" aria-labelledby="logging-tab">
      Logging
    </div>
    <div class="tab-pane fade py-4" id="users" role="tabpanel" aria-labelledby="users-tab">
      <table class="table table-striped bg-white">
        <thead>
          <tr>
            {%- block thead -%}
            {{ th("User (%i)" % users|length, 'name') }}
            {{ th("Admin", 'admin') }}
            {{ th("Last Activity", 'last_activity') }}
            {{ th("Running (%i)" % running|length, 'running', colspan=2) }}
            <th></th> {# admin access #}
            <th></th> {# spawner #}
            {%- endblock thead %}
          </tr>
        </thead>

        <tbody>
          {# First row #}
          <tr>
            <td>
              <div class="d-grid gap-2">
                <button id="add-users" type="button" class="btn btn-warning btn-rounded"
                  data-bs-toggle="modal" data-bs-target="#add-users-dialog">
                  Add Users
                </button>
              </div>
            </td>
            <td colspan="2"></td>
            <td class="text-center">
              <button id="start-all-servers" type="button" class="btn btn-block btn-rounded btn-primary mt-0"
                data-bs-toggle="modal" data-bs-target="#start-all-servers-dialog">
                Start All
              </button>
              <button id="stop-all-servers" type="button" class="btn btn-block btn-rounded btn-danger mt-0"
                data-bs-toggle="modal" data-bs-target="#stop-all-servers-dialog">
                Stop All
              </button>
            </td>
            <td colspan="2"></td>
            <td class="text-center">
              <button id="shutdown-hub" type="button" class="btn btn-block btn-rounded btn-danger"
                data-bs-toggle="modal" data-bs-target="#shutdown-hub-dialog">
                Shutdown Hub
              </button>
            </td>
          </tr>

          {#- Auto generate all other rows -#}
          {%- for user in users -%}
          {%- for spawner in user.all_spawners() %}
          <tr class="user-row server-row" id="user-{{user.name}}" data-user="{{ user.name }}"
            data-server-name="{{spawner.name}}" data-admin="{{user.admin}}">
    
            {%- block user_row scoped %}
            <td class="name-col">{{user.name}} {%- if spawner.name -%} /{{ spawner.name }} {%- endif -%}
            </td>
            <td class="admin-col">
              {%- if spawner.name == '' -%} {%- if user.admin %}yes{%- endif -%} {%- endif -%}
            </td>
            <td class="time-col">
              {%- if spawner.last_activity -%} {{ spawner.last_activity.isoformat() + 'Z' }}
              {%- else -%} Never
              {%- endif -%}
            </td>
            <td class="server-col text-center">
              <button role="button"
                class="stop-server btn btn-rounded btn-sm btn-danger{%- if not spawner.active %} d-none{%- endif -%}">
                stop server
              </button>
              <a type="button" target="_blank"
                class="start-server-admin btn btn-rounded btn-sm btn-primary{%- if spawner.active %} d-none{%- endif -%}">
                start server
              </a>
            </td>
            <td class="server-col">
              {%- if admin_access %}
              <a role="button" target="_blank"
                class="access-server btn btn-rounded btn-sm btn-primary{%- if not spawner.active %} d-none{%- endif -%}">
                access server
              </a>
              {%- endif %}
            </td>
            <td class="text-center">
              {%- if spawner.name == '' %}
              <button role="button" class="edit-user btn btn-rounded btn-sm btn-primary"
                data-bs-toggle="modal" data-bs-target="#edit-user-dialog">edit user</button>
              {%- endif %}
            </td>
            <td class="text-center">
              {%- if spawner.name == '' -%}
              {#- user row -#}
                {%- if user.name != current_user.name %}
                <button role="button" class="delete-user btn btn-rounded btn-sm btn-danger"
                  data-bs-toggle="modal" data-bs-target="#delete-user-dialog">delete user</button>
                {%- endif -%}
              {%- else %}
              {#- named spawner row -#}
              <button role="button" class="delete-server btn btn-rounded btn-sm btn-warning">delete server</button>
              {%- endif %}
            </td>
            {%- endblock user_row %}
          </tr>
    
          {%- endfor -%}
          {%- endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div id="version-footer" class="container-fluid small">
    <div class="navbar-text">
      JupyterHub {{ server_version }}
    </div>
  </div>

</div>


{%- call modal('Delete User', btn_class='btn-danger delete-button') -%}
Are you sure you want to delete user <span class="delete-username">USER</span>?
This operation cannot be undone.
{%- endcall -%}

{%- call modal('Stop All Servers', btn_label='Stop All', btn_class='btn-danger stop-all-button') -%}
Are you sure you want to stop all your users' servers? Kernels will be shutdown and unsaved data may be lost.
{%- endcall -%}

{%- call modal('Start All Servers', btn_label='Start All', btn_class='btn-primary start-all-button') -%}
Are you sure you want to start all servers? This can slam your server resources.
{%- endcall -%}

{%- call modal('Shutdown Hub', btn_label='Shutdown', btn_class='btn-danger shutdown-button') -%}
Are you sure you want to shutdown the Hub?
You can choose to leave the proxy and/or single-user servers running by unchecking the boxes below:
<div class="checkbox">
  <label>
    <input type="checkbox" class="shutdown-proxy-checkbox">Shutdown proxy
  </label>
</div>
<div class="checkbox">
  <label>
    <input type="checkbox" class="shutdown-servers-checkbox">Shutdown single-user-servers
  </label>
</div>
{%- endcall -%} 

{%- macro user_modal(name, multi=False) -%}
{%- call modal(name, btn_class='btn-primary save-button') -%}
<div class="form-group">
  <{%- if multi -%} textarea {%- else -%} input type="text" {%- endif %} class="form-control username-input"
    placeholder="{%- if multi -%} usernames separated by lines{%- else -%} username {%-endif-%}">
    {%- if multi -%}</textarea>{%- endif -%}
</div>
<div class="checkbox">
  <label>
    <input type="checkbox" class="admin-checkbox">Admin
  </label>
</div>
{%- endcall -%}
{%- endmacro -%}

{{ user_modal('Edit User') }}

{{ user_modal('Add Users', multi=True) }}


{%- endblock -%}


{%- block script -%}
<script type="text/javascript">
  require(["admin"]);
</script>

<script>
// Set active tab according to href on page load
function setActiveTab(activeTab) {
  // Set active nav tab
  $(".nav-link[data-bs-toggle='tab']").removeClass("active");
  $(".nav-link[href='#"+ activeTab + "']").addClass("active");
  // Set active nav content
  $(".tab-pane").removeClass("show active");
  $("#" + activeTab).addClass("show active");
}

var url = window.location.href;
var activeTab = url.substring(url.indexOf("#") + 1);
activeTab = activeTab.replace(/\/$/, ''); // Remove trailing slash
setActiveTab(activeTab);


// Show tab changes in sidebar
$('a[data-bs-toggle="tab"]').on("click", function() {
  const hash = $(this).attr("href");
  var newUrl = url.split("#")[0] + hash;
  history.replaceState(null, null, newUrl);
  
  if (hash == "#logging") {
    removeActive("User Labs");
    setActive("Logging");
  }
  else if (hash == "#users") {
    removeActive("Logging");
    setActive("User Labs");
  }
});

// Also change when hash is changed manually
window.addEventListener('hashchange', function() {
  const hash = url.split("#")[1];
  console.log(hash)
  if (hash == "users") {
    removeActive("User Labs")
    setActive("Logging");
    setActiveTab("logging")
  }
  else if (hash == "logging") {
    removeActive("Logging");
    setActive("User Labs");
    setActiveTab("users")
  }
}, false);
</script>
{%- endblock -%}

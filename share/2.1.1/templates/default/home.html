{%- extends hostname + "/page.html" %}

{%- block stylesheet -%}
  <link rel="stylesheet" href='{{static_url("css/home.css")}}' type="text/css"/>
  {# Vertical Tabs #}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-5-vertical-tabs@1.0.1/dist/b5vtabs.min.css"
    integrity="sha256-2yiJIxF53wjxXJpWRIHMVx2h6gbxPA9qR4PZ77fmA2k=" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
{%- endblock -%}


{%- set named_spawners = user.all_spawners(include_default=False) | list -%}
{%- set dropdown_lists = spawner_options_form.get("dropdown_lists") -%}
{%- set active_vo_config = custom_config.get("vos").get(auth_state.get("vo_active", ""), {}) -%} 
{%- set vo_services = active_vo_config.get("Services", {}) -%}
{%- set new = "new_jupyterlab" -%} {# id for new jupyterlabs #}


{% import hostname + '/home_macros.j2' as hmacro -%}


{%- block main -%}
<div class="p-4">
  <div class="d-flex align-items-center fs-1 mb-3">
    JupyterLabs
    <button class="btn btn-primary btn-lg new ms-3" data-bs-toggle="modal" data-bs-target="#{{new}}-dialog">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
        <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"/>
      </svg>
      <span class="align-middle">New</span>
    </button>
  </div>

  <p>You can configure your existing JupyterLabs by expanding the corresponding table row.</p>

  {# New Jupyterlab Dialog #}
  <div class="modal fade text-black" id="{{new}}-dialog" tabindex="-1" aria-labelledby="{{new}}-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="{{new}}-label">Configuration</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mt-2">
            {# Vertical tabs #}
            <div class="col-3">
              <ul class="nav nav-tabs left-tabs" role="tablist">
                {{ hmacro.vertical_tab("Service", new + "-service", active=true) }}
                {{ hmacro.vertical_tab("Options", new + "-options") }}
                {{ hmacro.vertical_tab("Resources", new + "-resources") }}
                {{ hmacro.vertical_tab("Reservation", new + "-reservation") }}
                {# {{ hmacro.vertical_tab("Modules", new + "-modules") }} #}
                {# {{ hmacro.vertical_tab("Kernel", new + "-kernel") }} #}
                </li>
              </ul>
            </div>

            {# Vertical tab content #}
            <div class="col-9">
              <div id="{{new}}-configuration" class="tab-content pt-0">
                {%- call hmacro.tab_content(new + "-service", active=true) -%}
                <div class="row mb-3">
                  <label for="{{new}}-name-input" class="col-sm-3 col-form-label">
                    Name
                    <span id="{{new}}-name-warning" class="badge rounded-pill bg-warning p-1 align-middle" style="display: none">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation" viewBox="0 0 16 16">
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0L7.1 4.995z"/>
                      </svg>
                      <span class="visually-hidden">name missing</span>
                    </span>
                  </label>
                  <div class="col-sm-9">
                    <input type="name" class="form-control" id="{{new}}-name-input" 
                      pattern="^[a-z0-9_]*$" maxlength="30"
                      placeholder="Please give your configuration a name.">
                    <small class="text-muted">Supported characters are a-z, 0-9 and '_'.</small>
                    <div class="invalid-feedback">
                      <b>Supported characters are a-z, 0-9 and '_'.</b>
                    </div>
                  </div>
                </div>
                {{ hmacro.form_div("Type", new, sm=3) }}
                {%- endcall -%}

                {%- call hmacro.tab_content(new + "-options") -%}
                {{ hmacro.form_div("System", new, sm=3) }}
                {{ hmacro.form_div("Account", new, sm=3) }}
                {{ hmacro.form_div("Project", new, sm=3) }}
                {{ hmacro.form_div("Partition", new, sm=3) }}
                {%- endcall -%}

                {%- call hmacro.tab_content(new + "-resources") -%}
                <form id="{{new}}-resources-form">
                  {{ hmacro.form_number_div("Nodes", new) }}
                  {{ hmacro.form_number_div("GPUs", new) }}
                  {{ hmacro.form_number_div("Runtime", new) }}
                </form>
                {%- endcall -%}

                {%- call hmacro.tab_content(new + "-reservation") -%}
                {{ hmacro.form_div("Reservation", new, sm=3) }}
                {%- endcall -%}

                {%- call hmacro.tab_content(new + "-modules") -%}
                {%- endcall -%}

                {%- call hmacro.tab_content(new + "-kernel") -%}
                {%- endcall -%}
              </div>
            </div>
          </div>
        </div>          
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="{{new}}-start-btn" class="btn btn-primary">Start</button>
        </div>
      </div>
    </div>
  </div>
  
  {# Table with existing JupyterLabs #}
  <div class="table-responsive">
    <table id="jupyterlabs-table" class="table table-bordered table-hover table-light align-middle">
      <thead class="table-secondary">
        <tr>
          <th scope="col"></th> {# Open/close details #}
          <th scope="col">Name</th>
          <th scope="col">System</th>
          <th scope="col">Partition</th>
          <th scope="col">Project</th>
          <th scope="col" style="width: 275px;">Status</th> {# Status #}
          <th scope="col" style="width: 210px;">Actions</th> {# Actions #}
        </tr>
      </thead>
      <tbody>
        {%- for s in named_spawners -%}
        {%- set spawner = s.orm_spawner -%}
        {%- set user_options = spawner.user_options -%}
        {%- if user_options -%}
        {%- set service = user_options.get("service_input") -%}
        {%- set option = user_options.get("options_input", "JupyterLab") -%}
        {%- set system = user_options.get("system_input", None) -%}
        {%- set account = user_options.get("account_input", None) -%}
        {%- set project = user_options.get("project_input", None) -%}
        {%- set partition = user_options.get("partition_input", None) -%}
        {%- set reservation = user_options.get("reservation_input", None) -%}
        {%- set nodes = user_options.get("resource_nodes", None) -%}
        {%- set runtime = user_options.get("resource_runtime", None) -%}
        {%- set gpus = user_options.get("resource_gpus", None) -%}
        {# Exclude dashboards and juniq labs #}
        {%- if user_options.get("service_input", "Dashboard") != "Dashboard" and user_options.get("vo_active_input", "default") != "juniq" -%}
        {{ hmacro.create_tr(spawner.name, s.active, service, option, system, account, project, partition, reservation, runtime, nodes, gpus) }}
        {{ hmacro.create_tr_collapse(spawner.name) }}
        {%- set table_has_rows = True -%}
        {%- endif -%}
        {%- endif -%}
        {%- endfor -%}
        {%- if not table_has_rows -%}
        <tr>
          <td></td>
          <td colspan="5%" class="fst-italic text-muted">No JupyterLabs configured yet.<td>
        </tr>
        {%- endif -%}
      </tbody>
    </table>
  </div>
</div>

{# {{spawner_options_form.get('resources')}} #}
{%- endblock -%}


{%- block script -%}
<script>
// Make user_options globally available in JS
var user_options = {};
{%- for s in named_spawners -%}
{%- set spawner = s.orm_spawner -%}
{%- set user_options = spawner.user_options -%}
{%- if user_options and user_options.get("service_input") == "JupyterLab" and user_options.get("vo_active_input") != "juniq"%}
user_options["{{spawner.name}}"] = {{ user_options | tojson }}
{%- endif -%}
{%- endfor %}

require(["home-components"]);
</script>

<script>
/* Callbacks for new JupyterLabs */
$(document).ready(function () {
  // New jupyterlabs
  $("#{{new}}-name-input").val(""); // Reset name
  updateOption1("{{new}}"); // Trigger dropdown option updates
  $("#{{new}}-name-input").addClass("border-warning");
  $("#{{new}}-name-warning").show();
  // Trigger warning badge in service tab of new lab configuration
  $("#{{new}}-service-tab-warning")[0].dispatchEvent(new Event("change"));
})

// Reset all dropdowns after closing the new jupyterlab dialog
$("#{{new}}-dialog").on('hidden.bs.modal', function (event) {
  // Reset name
  $("#{{new}}-name-input").val("");
  // Reset all dropdowns and inputs
  $("#{{new}}-dialog").find("select, input").each(function() {
    $(this).val(null);
  })

  // Trigger dropdown option updates
  updateOption1("{{new}}"); 
  $("#{{new}}-name-input").addClass("border-warning");
  $("#{{new}}-name-warning").show();
  // Trigger warning badge in service tab of new lab configuration
  $("#{{new}}-service-tab-warning")[0].dispatchEvent(new Event("change"));

  // Show first tab after resetting values
  var trigger = $("#{{new}}-service-tab");
  var tab = new bootstrap.Tab(trigger);
  tab.show();
})
</script>

<script>
/* Set initial values */
function setValues(name, options) {
  var id = name;
  var option1 = options["options_input"];
  var system = options["system_input"];
  var account = options["account_input"];
  var project = options["project_input"];
  var partition = options["partition_input"];
  var reservation = options["reservation_input"];
  var nodes = options["resource_Nodes"];
  var runtime = options["resource_Runtime"];
  var gpus = options["resource_GPUS"];

  if (!account) account = "None";
  if (!project) project = "None";
  if (!partition) partition = "None";
  if (!reservation) reservation = "None";

  // Need to run all updates manually to set the correct initial values
  updateOption1(id, option1);
  updateSystems(id, option1, system);
  updateAccounts(id, option1, system, account);
  updateProjects(id, option1, system, account, project);
  updatePartitions(id, option1, system, account, project, partition);
  updateResources(id, option1, system, account, project, partition, reservation);
}

$(document).ready(function () {
  // Set values for all existing Labs
  for (const [name, options] of Object.entries(user_options)) {
    setValues(name, options);
    removeWarnings(name); // Remove all warning badges
  }

  $("tr[data-server-name]").not(".collapse-tr").each(function () {
    var na = $(this).find(".na-status").text();
    if ( na == 1 ) {
      $(this).addClass("text-muted");
      $(this).find(".btn").not(".btn[id*=log-btn]").attr("disabled", true);
    }
  })

  // Disable edit buttons again
  $(".save").attr("disabled", true);
  $(".reset").attr("disabled", true);

  // Update spawners in table if they are currently running or their spawn is pending
  // Update logs for all spawners if log exists
  updateSpawners();
})
</script>

<script>
/* On user chaning JupyterLab configurations */
$("select[id*=type]").change(function() {
  var id = $(this).attr("id").split('-')[0];
  var option = $(this).val();
  updateSystems(id, option);
});

$("select[id*=system]").change(function() {
  var id = $(this).attr("id").split('-')[0];
  var option = $("select#" + id + "-type-select").val();
  var system = $(this).val();
  updateAccounts(id, option, system);
});

$("select[id*=account]").change(function() {
  var id = $(this).attr("id").split('-')[0];
  var option = $("select#" + id + "-type-select").val();
  var system = $("select#" + id + "-system-select").val();
  var account = $(this).val();
  updateProjects(id, option, system, account);
});

$("select[id*=project]").change(function() {
  var id = $(this).attr("id").split('-')[0];
  var option = $("select#" + id + "-type-select").val();
  var system = $("select#" + id + "-system-select").val();
  var account = $("select#" + id + "-account-select").val();
  var project = $(this).val();
  updatePartitions(id, option, system, account, project);
});

$("select[id*=partition]").change(function() {
  var id = $(this).attr("id").split('-')[0];
  var option = $("select#" + id + "-type-select").val();
  var system = $("select#" + id + "-system-select").val();
  var account = $("select#" + id + "-account-select").val();
  var project = $("select#" + id + "-project-select").val();
  var partition = $(this).val();
  updateResources(id, option, system, account, project, partition);
});
</script>

<script>
/* Functions handling changes in JupyterLab configurations */

function updateOption1(id, value=null) {
  var select = $("select#" + id + "-type-select");
  var values = []
  var old_value = select.val();

  select.html("");
  {%- for option in spawner_options_form.get('dropdown_lists', {}).get('options', {}).keys() | unique %}
    select.append('<option value="{{option}}">{{ custom_config.get("services").get("JupyterLab").get("options").get(option).get("name") }}</option>');
    values.push("{{option}}");
  {%- endfor %}
  updateSelect(select, id, value, old_value, values, tab_id="service");
}

function updateSystems(id, option, value=null) {
  var select = $("select#" + id + "-system-select");
  var values = []
  var old_value = select.val();

  select.html("");
  {%- for option, systems_allowed in spawner_options_form.get("dropdown_lists", {}).get("options", {}).items() %}
  if (option == {{ option | tojson }}) {
    {%- for system in spawner_options_form.get("dropdown_lists", {}).get("systems", []) %}
      {%- if system in systems_allowed.keys() %}
      select.append('<option value="{{system}}">{{ system }}</option>');
      values.push("{{system}}");
      {%- endif %}
    {%- endfor %}
  }
  {%- endfor %}
  updateSelect(select, id, value, old_value, values);
}

function updateAccounts(id, option, system, value=null) {
  var select = $("select#" + id + "-account-select");
  var values = []
  var old_value = select.val();

  select.html("");
  select.removeClass("text-muted");
  select.attr("required", true);
  {%- for option, systems_allowed in spawner_options_form.get("dropdown_lists", {}).get("options", {}).items() %}
    {%- for system, accounts_allowed in systems_allowed.items() %}
      {%- if spawner_options_form.get('dropdown_lists').get('accounts', {}).get(system, []) | length > 0 %} 
      if (option == {{ option | tojson }} && system == {{ system | tojson }}) {
        {%- for account in spawner_options_form.get('dropdown_lists', {}).get('accounts', {}).get(system, []) | unique | sort %}
          {%- if account in accounts_allowed.keys() %}
          select.append('<option value="{{account}}">{{ account }}</option>');
          values.push("{{account}}");
          {%- endif %}
        {%- endfor %}
      }
      {%- endif %}
    {%- endfor %}  
  {%- endfor %}
  updateSelect(select, id, value, old_value, values);
}

function updateProjects(id, option, system, account, value=null) {
  var select = $("select#" + id + "-project-select");
  var values = []
  var old_value = select.val();
  
  select.html("");
  select.removeClass("text-muted");
  select.attr("required", true);
  {%- for option, systems_allowed in spawner_options_form.get('dropdown_lists', {}).get('options', {}).items() %}
    {%- for system, accounts_allowed in systems_allowed.items() %}
      {%- for account, projects_allowed in accounts_allowed.items() %}
        {%- if spawner_options_form.get('dropdown_lists').get('projects', {}).get(system, {}).get(account, []) | length > 0 %} 
        if (option == {{ option | tojson }} && system == {{ system | tojson }} && account == {{ account | tojson }}) {
          {%- for project in spawner_options_form.get('dropdown_lists', {}).get('projects', {}).get(system, {}).get(account, []) | unique | sort %}
            {%- if project in projects_allowed.keys() %}
            select.append('<option value="{{project}}">{{ project }}</option>');
            values.push("{{project}}");
            {%- endif %}
          {%- endfor %}
        }
        {%- endif %}
      {%- endfor %} {# account #}
    {%- endfor %} {# system #}
  {%- endfor %} {# option #}
  updateSelect(select, id, value, old_value, values);
}

function updatePartitions(id, option, system, account, project, value=null) {
  var select = $("select#" + id + "-partition-select");
  var warning = $("#" + id + "-partition-warning");
  var values = []
  var old_value = select.val();

  select.html("");
  select.removeClass("text-muted");
  select.attr("required", true);
  // Distinguish between login and compute nodes
  var login_nodes = []
  var compute_nodes = []
  {%- for option, systems_allowed in spawner_options_form.get('dropdown_lists', {}).get('options', {}).items() %}
    {%- for system, accounts_allowed in systems_allowed.items() %}
      {%- for account, projects_allowed in accounts_allowed.items() %}
        {%- for project, partitions_allowed in projects_allowed.items() %}
          {%- if spawner_options_form.get('dropdown_lists').get('partitions', {}).get(system, {}).get(account, {}).get(project, []) | length > 0 %}
          if (option == {{ option | tojson }} && system == {{ system | tojson }} && account == {{ account | tojson }} && project == {{ project | tojson }}) {
            {%- for partition in spawner_options_form.get('dropdown_lists', {}).get('partitions', {}).get(system, {}).get(account, {}).get(project, []) | unique %}
              {%- if partition in partitions_allowed.keys() %}
              values.push("{{partition}}");
              {%- set systems = custom_config.get("systems") -%}
              {%- if system in systems.get("UNICORE").keys() %}
              var interactive_partitions = {{ systems.get("UNICORE").get(system).get("interactive_partitions", []) | tojson }}
              {%- elif system in systems.get("K8s").keys() %}
              var interactive_partitions = {{ systems.get("K8s").get(system).get("interactive_partitions", []) | tojson }}
              {%- endif %}
              if ( interactive_partitions.includes("{{partition}}") ) {
                login_nodes.push("{{partition}}");
              } else compute_nodes.push("{{partition}}");
              {%- endif %}
            {%- endfor %}
          }
          {%- endif %}
        {%- endfor %} {# project #}
      {%- endfor %} {# account #}
    {%- endfor %} {# system #}
  {%- endfor %} {# option #}

  if (login_nodes.length > 0) {
    select.append('<optgroup label="Login Nodes">');
    login_nodes.forEach((x) => select.append(`<option value="${x}">${x}</option>`))
    select.append('</optgroup>');
  }
  if (compute_nodes.length > 0) {
    select.append('<optgroup label="Compute Nodes">');
    compute_nodes.forEach((x) => select.append(`<option value="${x}">${x}</option>`))
    select.append('</optgroup>');
  }
  updateSelect(select, id, value, old_value, values);
}

function updateResources(id, option, system, account, project, partition, reservation=null) {
  var nodes_input = $("input#" + id + "-nodes-input");
  var gpus_input = $("input#" + id + "-gpus-input");
  var runtime_input = $("input#" + id + "-runtime-input");
  var reservation_select = $("select#" + id + "-reservation-select");
  // Save old values
  var old_resource_values = {
    "nodes": nodes_input.val(),
    "gpus": gpus_input.val(),
    "runtime": runtime_input.val(),
  }
  var old_reservation_value = reservation_select.val();
  var reservation_values = [];
  // Reset all values
  var resources = [nodes_input, gpus_input, runtime_input, reservation_select];
  resources.forEach(function(resource) {
    resource.val(null);
    resource.removeAttr("required");
  });
  reservation_select.html("");
  // Disable tabs
  var resource_tab = $("#" + id + "-resources-tab");
  var reservation_tab = $("#" + id + "-reservation-tab");
  var should_show = false;
  resource_tab.addClass("disabled");
  reservation_tab.addClass("disabled");

  {%- for option, systems_allowed in spawner_options_form.get('dropdown_lists', {}).get('options', {}).items() %}
    {%- for system, accounts_allowed in systems_allowed.items() %}
      {%- for account, projects_allowed in accounts_allowed.items() %}
        {%- for project, partitions_allowed in projects_allowed.items() %}
          {%- for partition, reservations_allowed in partitions_allowed.items() %}
          if (option == {{ option | tojson }} && system == {{ system | tojson }} && account == {{ account | tojson }} && project == {{ project | tojson }} && partition == {{ partition | tojson }}) {
            {%- if "nodes" in spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}) %}
            var min = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("nodes", {}).get("minmax", [0, 1])[0] }};
            var max = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("nodes", {}).get("minmax", [0, 1])[1] }};
            if (user_options[id] && user_options[id]["resource_nodes"]) {
              var value = user_options[id]["resource_nodes"];
            } else
              var value = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("nodes", {}).get("default", 0) }};

            $("#" + id + "-nodes-text").text("Nodes [" + min + "," + max + "]");
            nodes_input.attr({"min": min, "max": max, "value": value});
            nodes_input.val(value);
            nodes_input.attr("required", true);
            // Set message for invalid feedback
            nodes_input.siblings(".invalid-feedback").text(`Please choose a number between ${min} and ${max}.`);
            updateInput(id, old_resource_values["nodes"], value, min, max, nodes_input);
            $("#" + id + "-nodes-input-div").show();
            var should_show = true;
            {%- else %}
            $("#" + id + "-nodes-input-div").hide();
            // Show warning even if the div is hidden 
            // if we changed from an existing value to not having a value
            if ( old_resource_values["nodes"] != "" ) {
              $("#" + id + "-nodes-warning").show();
            }
            {%- endif %}

            {%- if "gpus" in spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}) %}
            var min = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("gpus", {}).get("minmax", [0, 1])[0] }};
            var max = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("gpus", {}).get("minmax", [0, 1])[1] }};
            if (user_options[id] && user_options[id]["resource_gpus"]) {
              var value = user_options[id]["resource_gpus"];
            } else
              var value = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("gpus", {}).get("default", 0) }};

            $("#" + id + "-gpus-text").text("GPUs [" + min + "," + max + "]");
            gpus_input.attr({"min": min, "max": max, "value": value});
            gpus_input.val(value);
            gpus_input.attr("required", true);
            // Set message for invalid feedback
            gpus_input.siblings(".invalid-feedback").text(`Please choose a number between ${min} and ${max}.`);
            $("#" + id + "-gpus-input-div").show();
            var should_show = true;
            updateInput(id, old_resource_values["gpus"], value, min, max, gpus_input);
            {%- else %}
            $("#" + id + "-gpus-input-div").hide();
            // Show warning even if the div is hidden 
            // if we changed from an existing value to not having a value
            if ( old_resource_values["gpus"] != "" ) {
              $("#" + id + "-gpus-warning").show();
            }
            {%- endif %}

            {%- if "runtime" in spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}) %}
            var min = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("runtime", {}).get("minmax", [0, 1])[0] }};
            var max = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("runtime", {}).get("minmax", [0, 1])[1] }};
            if (user_options[id] && user_options[id]["resource_runtime"]) {
              var value = user_options[id]["resource_runtime"] / 60;
            } else
              var value = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("runtime", {}).get("default", 0) }};
            $("#" + id + "-runtime-text").text("Runtime (min) [" + min + "," + max + "]");
            runtime_input.attr({"min": min, "max": max, "value": value});
            runtime_input.val(value);
            runtime_input.attr("required", true);
            // Set message for invalid feedback
            runtime_input.siblings(".invalid-feedback").text(`Please choose a number between ${min} and ${max}.`);
            updateInput(id, old_resource_values["runtime"], value, min, max, runtime_input)
            $("#" + id + "-runtime-input-div").show();
            var should_show = true;
            {%- else %}
            $("#" + id + "-runtime-input-div").hide();
            // Show warning even if the div is hidden 
            // if we changed from an existing value to not having a value
            if ( old_resource_values["runtime"] != "" ) {
              $("#" + id + "-runtime-warning").show();
            }
            {%- endif %}

            {%- if reservations_allowed | length > 0 and reservations_allowed != ["None"] %}
              {%- for reservation in spawner_options_form.get('dropdown_lists', {}).get('reservations', {}).get(system, {}).get(account, {}).get(project, {}).get(partition, []) | unique %}
                {%- if reservation in reservations_allowed %}
                  {%- if reservation == "None" %}
                  $("#" + id + "-reservation-select").append('<option>{{reservation}}</option>');
                  reservation_values.push("{{reservation}}");
                  {%- else %}
                    {# Check Reservation Info Dict for more information #}
                    {%- for reservation_line in spawner_options_form.get('reservations', {}).get(system, []) %}
                      {%- if reservation == reservation_line[0] %}
                        {%- if reservation_line[14] == "INACTIVE" %}
                          $("#" + id + "-reservation-select").append('<option disabled style="color: #6c757d;">{{reservation}} [INACTIVE]</option>');
                          reservation_values.push("{{reservation}}");
                        {%- else %}
                          $("#" + id + "-reservation-select").append('<option>{{reservation}}</option>');
                          reservation_values.push("{{reservation}}");
                        {%- endif %}
                      {%- endif %}
                    {%- endfor %}
                  {%- endif %}
                {%- endif %} {# reservation in reservations_allowed #}
              {%- endfor %}    
                    
              if (user_options[id] && user_options[id]["reservation_input"]) {
                $("#" + id + "-reservation-select").val(user_options[id]["reservation_input"]);
              }
              reservation_select.attr("required", true);
              $("#" + id + "-reservation-select-div").show();
              reservation_tab.removeClass("disabled");
              if ( reservation != "None" ) {
                  updateSelectValue(id, old_reservation_value, reservation_values, reservation_select, tab_id="reservation");
              } else {
                reservation_select.val(reservation);
              }
            {%- else %}
              $("#" + id + "-reservation-select-div").hide();
            {%- endif %} {# reservations_allowed #}

          } {# end of comparison of options (option == option) #}
          {%- endfor %} {# partitions #}
        {%- endfor %} {# project #}
      {%- endfor %} {# account #}
    {%- endfor %} {# system #}
  {%- endfor %} {# option #}

  // Only check at end if we should enable the tab so that the 
  // updateInput function gets the correct value for disabled
  if (should_show) {
    resource_tab.removeClass("disabled");
  }
  // Dispatch update event at the very end so that the warning
  // symbol disappears if the tab is disabled
  var resources_tab_warning = $("#" + id + "-resources-tab-warning");
  resources_tab_warning[0].dispatchEvent(new Event("change"));
  var reservation_tab_warning = $("#" + id + "-reservation-tab-warning");
  reservation_tab_warning[0].dispatchEvent(new Event("change"));
}
</script>

<script>
/* Connect to SSE to get notified of new servers */
evtSources = {}
{#- Manually set cancel_progress_activation until added to template -#}
{%- set cancel_progress_activation = 30 %}

function updateSpawners() {
  {%- for s in named_spawners -%}
    {%- if s.progress_dic -%}
      var progress_dic = {{s.progress_dic | tojson}};
      var last_progress = {{s.progress_number}};

      var name = "{{s.name}}";
      var progress_bar = $("#" + name + "-progress-bar");
      var progress_log = $("#" + name + "-progress-log");

      var tr = progress_bar.parents("tr");
      var open_btn = tr.find(".open");
      var stop_btn = tr.find(".stop");
      
      // Append log messages
      for (const progress in progress_dic) {
        var html_message = progress_dic[progress]["html_message"];
        progress_log.append($("<div>").html(html_message));
        // tab_log.append($("<div>").html(html_message));
      }

      // Make progress td visible and set the progress bar to the correct width
      // if the spawner if currenty spawning
      {%- if not s.ready and s.active %}
      progress_bar.css("width", "100%");
      progress_bar.attr("aria-valuenow", last_progress);
      progress_bar.append( $("b").html(last_progress + "%") );
      // open_btn.addClass("disabled");
      if (last_progress < {{cancel_progress_activation}}) {
        stop_btn.addClass("disabled");
      }
      // Disable the delete button during the spawn process
      var server_name = tr.data("server-name");
      var collapse = tr.siblings(`.collapse-tr[data-server-name=${server_name}]`);
      collapse.find(".delete").addClass("disabled");

      // Reattach event listener
      var progress_url = `${jhdata.base_url}api/users/${jhdata.user}/servers/${name}/progress`;
      evtSources[name] = new EventSource(progress_url);
      // save variables in evtSource Object and use outside of loop to avoid overwriting
      // what is a better solution for this?
      evtSources[name]["name"] = name;
      evtSources[name]["progress_bar"] = progress_bar;
      evtSources[name]["progress_log"] = progress_log;

      {%- elif s.active %}
      progress_bar.css("width", "100%");
      progress_bar.attr("aria-valuenow", last_progress);
      progress_bar.addClass('bg-success');
      {%- endif %}

    // Try to append logs from last spawn
    {%- elif s.orm_spawner.progress %}
    var progress_dic = {{s.orm_spawner.progress | tojson}};
    var progress_log = $("#{{s.name}}-progress-log");
    for (const progress in progress_dic) {
      var html_message = progress_dic[progress]["html_message"];
      progress_log.append($("<div>").html(html_message));
    }
    {%- endif %}
  {%- endfor %}

  for (const name in evtSources) {
    evtSources[name].onmessage = function (e) {
      onEvtMessage(e, evtSources[name], evtSources[name]["progress_bar"], evtSources[name]["progress_log"]);
    }
  }
}

// Handle EventSource message
function onEvtMessage(event, evtSource, progress_bar, progress_log) {
  var tr = progress_bar.parents("tr");
  var server_name = tr.data("server-name");
  var collapse = tr.siblings(`.collapse-tr[data-server-name=${server_name}]`);
  var open_btn = tr.find(".open");
  var stop_btn = tr.find(".stop");
  var delete_btn = collapse.find(".delete").addClass("disabled");

  var evt = JSON.parse(event.data);
  // console.log(evt);

  if (evt.progress !== undefined && evt.progress != 0) {
    // update progress
    // progress_bar.css("width", evt.progress + "%");
    progress_bar.css("width", "100%");
    progress_bar.html("<b>" + evt.progress + "%</b>");
    progress_bar.attr("aria-valuenow", evt.progress);
    delete_btn.addClass("disabled")

    if (evt.progress >= {{cancel_progress_activation}}) {
      stop_btn.removeClass("disabled");
    }
  }

  if (evt.html_message !== undefined) {
    var html_message = evt.html_message
    html_message = html_message.replace(/&nbsp;/g, ' ');
  } else if (evt.message !== undefined) {
    var html_message = evt.message;
    html_message = html_message.replace(/&nbsp;/g, ' ');
  }
  if (html_message) {
    progress_log.append($("<div>").html(html_message));
  }

  if (evt.ready) {
    evtSource.close();
    delete evtSources[evtSource.name];
    progress_bar.html('');
    progress_bar.addClass("bg-success");
    open_btn.removeClass("disabled");
    delete_btn.removeClass("disabled")
  }

  if (evt.failed) {
    evtSource.close();
    delete evtSources[evtSource.name];
    progress_bar.html('');
    progress_bar.attr("aria-valuenow", 100);
    progress_bar.addClass("bg-danger");
    // Change buttons to start or N/A
    var na = tr.find(".na-status").text();
    if (na == "1") {
        tr.find(".na").removeClass("d-none")
        tr.find(".start").addClass("d-none");
    } else {
      tr.find(".na").addClass("d-none")
      tr.find(".start").removeClass("d-none");
    }
    open_btn.addClass("d-none");
    stop_btn.addClass("d-none");
    delete_btn.removeClass("disabled")
  }
}
</script>

<script src='{{static_url("js/home-servers.js", include_version=False) }}' type="text/javascript" charset="utf-8"></script>
<script src='{{static_url("js/home-components.js", include_version=False) }}' type="text/javascript" charset="utf-8"></script>
{%- endblock %}
